# Финансовый журнал проекта

Финансовый таб проекта объединяет расчёт стоимости оборудования, продажи, субподряд и фактические платежи. Основной интерфейс реализован в шаблоне [`project_finance.twig`](../src/project/project_finance.twig), а формы добавления и скрипты находятся в `project_index.twig`.

## Сводные показатели
- Верхняя таблица показывает ключевые суммы: стоимость оборудования, скидки/корректировки, итог по субарендам, кадровые затраты и полученные платежи. Значения берутся из структуры `FINANCIALS`, подготовленной бекэндом. 【F:src/project/project_finance.twig†L3-L83】
- Кнопка «Add Payment Received» и выпадающее меню доступные при наличии права `PROJECTS:PROJECT_PAYMENTS:CREATE` открывают модальное окно для ввода нового платежа, продажи, субаренды или затрат на персонал. 【F:src/project/project_finance.twig†L84-L99】
- В футере карточки расположен переход в справку, что помогает быстро свериться с инструкциями по тарификации. 【F:src/project/project_finance.twig†L84-L99】

## Инвойсы и сопроводительные заметки
- Карточки «Invoice Notes» и «Delivery Notes» показывают текстовые поля проекта; если у пользователя есть права редактирования, отображается кнопка для открытия модального редактора. 【F:src/project/project_finance.twig†L102-L139】
- Эти поля часто используют для условий оплаты, адресов доставки и дополнительных инструкций, которые автоматически попадают в PDF-документы.

## Подробные журналы
- Для каждой категории расходов (продажи, субаренда, персонал) формируются отдельные таблицы с группировкой по поставщику и возможностью удалить строку или открыть список прикреплённых файлов, если файловый модуль включён. 【F:src/project/project_finance.twig†L140-L293】
- Полученные платежи выводятся в собственной таблице с отображением даты, метода и комментария. Для каждой записи доступны вложения и удаление по правам. 【F:src/project/project_finance.twig†L297-L338】

## Создание и управление проводками
- Модальное окно добавления платежа содержит поля для всех типов операций: дата и референс для входящих платежей, количество и поставщик для расходов, общий комментарий и сумма. 【F:src/project/project_index.twig†L428-L498】
- При выборе типа операции скрипт переключает набор полей, чтобы скрыть лишние элементы и проставить корректный заголовок. После сохранения данные отправляются в `projects/newPayment.php` и страница обновляется. 【F:src/project/project_index.twig†L1337-L1375】
- Удаление записи подтверждается через Bootbox и вызывает `projects/deletePayment.php`. Это защищает от случайных действий и синхронизирует журнал с кешем проекта. 【F:src/project/project_index.twig†L1377-L1399】

## Работа с вложениями
- Если файловый модуль включён и у пользователя есть права `PROJECTS:PROJECT_PAYMENTS:VIEW:FILE_ATTACHMENTS`, рядом с операцией отображается кнопка со значком скрепки. Число на кнопке показывает количество файлов, прикреплённых к записи. 【F:src/project/project_finance.twig†L180-L332】

## Практические советы
1. При закрытии проекта сначала внесите все расходы (субаренды и персонал), а затем зафиксируйте фактический платёж — так итоговый остаток в блоке «Grand Total Outstanding» всегда будет точным. 【F:src/project/project_finance.twig†L40-L83】【F:src/project/project_finance.twig†L200-L338】
2. Используйте поля Invoice/Delivery Notes для хранения уникальных условий клиента; эти значения будут доступны команде логистики и бухгалтерии в одном месте. 【F:src/project/project_finance.twig†L102-L139】
3. Для журналирования наличных оплат используйте отдельный метод оплаты и прикрепляйте сканы чеков через кнопку вложений, чтобы упростить аудит. 【F:src/project/project_finance.twig†L297-L333】
