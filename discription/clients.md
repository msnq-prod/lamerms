# Клиенты и финансовая история

Раздел клиентов помогает управлять контактами, а также контролировать оплату проектов. Контроллер `clients.php` отвечает за выборку, а шаблон `clients.twig` строит интерактивную таблицу с фильтрами и действиями.

## Фильтры и поиск
- Пользователь может включать архивные карточки, показывать проекты с выпущенными активами и будущие мероприятия через параметры запроса. Все переключатели отражаются в шапке таблицы. 【F:src/clients.php†L13-L55】【F:src/clients.twig†L18-L33】
- Текстовый поиск проходит по имени, адресу, телефону, e-mail, сайту и заметкам клиента; строки предварительно санитизируются для предотвращения инъекций. 【F:src/clients.php†L10-L39】
- Пагинация ограничивает выдачу двадцатью записями на страницу и сохраняет номер текущей страницы, чтобы при обновлении формы пользователь возвращался к нужному месту. 【F:src/clients.php†L24-L43】

## Агрегация финансовых показателей
- Для каждого клиента подбираются все непомеченные как удалённые проекты текущего инстанса, но только те типы, где включён финансовый учёт. 【F:src/clients.php†L45-L55】
- Перед подсчётом задолженностей модуль загружает кеш финансов проекта, проверяя его наличие. Ошибка выбрасывается, если кеш отсутствует, чтобы подсветить проблемы консистентности. 【F:src/clients.php†L58-L63】
- Итоговые суммы собираются в объект `Money`: отдельные поля для полученных платежей и для общей суммы по невыпущенным проектам. Это позволяет отображать «Оплачено» и «К оплате» в интерфейсе. 【F:src/clients.php†L56-L72】

## Интерфейс таблицы
- Заголовок карточки динамически показывает выбранную поисковую строку и состояние фильтров, а в тулбаре доступны кнопки «Добавить клиента» и смены режимов, если у пользователя есть права. 【F:src/clients.twig†L9-L41】
- Таблица включает быстрые действия: переход к списку проектов клиента, открытие адреса в Google Maps, ссылки на сайт, отображение заметок и валютные значения с форматированием. 【F:src/clients.twig†L48-L84】
- В конце карточки выводится пагинация с подсветкой активной страницы и кнопками «назад/вперёд», построенными через Twig-фильтр `modifyGet`, чтобы не терять остальные параметры запроса. 【F:src/clients.twig†L160-L179】

## Редактирование и архивирование
- Кнопка редактирования открывает модальное окно с полной формой карточки клиента; данные отправляются через AJAX на `clients/edit.php`, после чего страница автоматически обновляется. 【F:src/clients.twig†L86-L145】【F:src/clients.twig†L200-L205】
- Архивирование и восстановление используют подтверждение через Bootbox и асинхронные вызовы `clients/archive.php` и `clients/unarchive.php`, что позволяет очищать или возвращать записи без перезагрузки списка. 【F:src/clients.twig†L206-L252】
- Создание нового клиента доступно из того же тулбара и инициирует AJAX-запрос на `clients/new.php`, после чего UI перерисовывается. 【F:src/clients.twig†L188-L197】

## Практические советы
1. При анализе просроченных оплат включайте проекты с выпущенными активами — так в столбце «К оплате» останутся только реально неоплаченные суммы. 【F:src/clients.php†L66-L72】【F:src/clients.twig†L24-L28】
2. Используйте встроенный поиск по адресу и кнопку Google Maps, чтобы быстро строить маршрут для выездных встреч. 【F:src/clients.php†L30-L35】【F:src/clients.twig†L71-L76】
3. Храните заметки в карточке клиента: они отображаются прямо в таблице и помогают менеджерам учитывать индивидуальные условия работы. 【F:src/clients.php†L33-L38】【F:src/clients.twig†L80-L82】
