# Каталог и карточки активов

Модуль активов покрывает весь жизненный цикл оборудования: от поиска нужной позиции до отслеживания состояния конкретного экземпляра. Контроллеры `assets.php` и `asset.php` формируют выдачу с учётом прав пользователя, фильтров и внутренних справочников.

## Конструктор поискового запроса
- На этапе подготовки запроса собираются все параметры: инстанс, проект-реферер, страница и лимит, пользовательские настройки видимости архивов/связок/изображений, а также подборки по категориям, производителям, группам, тегам и ключевым словам. 【F:src/assets.php†L16-L123】
- При передаче дат или ID проекта система проверяет доступ и автоматически подменяет диапазон на фактический график доставки, чтобы исключить конфликты по расписанию. 【F:src/assets.php†L59-L88】
- Каждому сеансу соответствует структура `$RETURN`, которая хранит пагинацию, выбранный проект и итоговую выдачу типов активов. Это упрощает передачу данных в Twig. 【F:src/assets.php†L43-L88】

## Фильтры, сортировка и подготовка списка
- Перед выборкой типов активов выполняются соединения со справочниками категорий, групп категорий и производителей; фильтры применяются только если пользователь выбрал значения. 【F:src/assets.php†L92-L110】
- Сортировка может выполняться по цене, стоимости, алфавиту, массе или дате добавления, а затем всегда дублируется сортировка по имени для стабильности результата. 【F:src/assets.php†L101-L113】
- Вложенный `subQuery` формирует пул допустимых экземпляров, отсекая удалённые, архивные, связанные и не подходящие по тегам позиции ещё до основной выборки. 【F:src/assets.php†L130-L166】
- Для каждого типа активов повторно применяется та же логика фильтрации уже на уровне экземпляров, поэтому итоговые показатели `count`, `countAvailable` и `countBlocked` отражают реальное состояние склада. 【F:src/assets.php†L175-L238】

## Вычисление доступности и статусов
- Когда указан диапазон дат, модуль проверяет назначения каждого экземпляра и исключает позиции, задействованные в пересекающихся проектах, с учётом статуса «активы выпущены». 【F:src/assets.php†L218-L235】
- Функция `assetFlagsAndBlocks` добавляет сведения о блокировках и флагах, что позволяет быстро увидеть причины недоступности (например, сервисные отметки). 【F:src/assets.php†L232-L234】
- Показатель `countAvailable` вычисляется как разница между общим числом и количеством заблокированных/занятых единиц — эти данные используются в интерфейсе выбора оборудования. 【F:src/assets.php†L211-L237】

## Дополнительные данные и вложения
- Для каждого типа активов хранятся настраиваемые поля и миниатюра, извлекаемая из S3, что позволяет выводить кастомные спецификации. 【F:src/assets.php†L214-L216】
- На уровне экземпляра доступны заметки, штрих-коды, масса, ставки аренды и до десяти определяемых полей, что поддерживает учёт нестандартных параметров. 【F:src/assets.php†L208-L235】
- В карточке актива выгружаются миниатюры, файлы, история назначений и место хранения, а также дерево связанных активов и список групп, если отображается единственный экземпляр. 【F:src/asset.php†L19-L133】

## Штрихкоды и отслеживание перемещений
- При просмотре одного экземпляра выгружаются все связанные штрихкоды вместе с последними сканированиями, исполнителями и локациями, что позволяет восстановить путь оборудования. 【F:src/asset.php†L134-L165】
- Дополнительно отображаются последние 50 событий сканирования, а также вычисляется текущее местоположение (локация, вложенный актив или произвольное описание). 【F:src/asset.php†L155-L177】

## Связь с обслуживанием и локациями
- Если выдаётся ровно один экземпляр, карточка обогащается активными задачами обслуживания, чтобы инженеры видели требования к ремонту в одном окне. 【F:src/asset.php†L86-L103】
- В модуле доступны списки производителей, категорий и локаций с вложенной иерархией, что ускоряет ручное переназначение мест хранения и редактирование типа. 【F:src/asset.php†L74-L209】

## Практика использования
1. Используйте параметры `SHOWARCHIVED` и `SHOWLINKED` при подборе комплекта, чтобы не перегружать выдачу неактуальными или вложенными элементами. 【F:src/assets.php†L22-L166】
2. При проверке доступности проекта открывайте каталог с фильтром по ID проекта — тогда даты подтянутся автоматически, а занятие активов покажется в карточке. 【F:src/assets.php†L59-L237】
3. Просматривайте блок «Штрихкоды» перед отправкой — он показывает последние перемещения и помогает сверить фактическое местоположение оборудования. 【F:src/asset.php†L134-L177】
