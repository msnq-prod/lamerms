# MVP Cutover Risk Assessment and Safeguards

Этот документ помогает провести сокращение функциональности AdamRMS до складского MVP и при этом не сломать рабочее окружение. Ниже перечислены критические зависимости, симптомы возможных ошибок и шаги, которые нужно выполнить перед деплоем.

## 1. Маршрутизация, include'ы и автозагрузка
- **Риск:** после переноса модулей в `/legacy` контроллеры в `index.php`, `src/common/router.php`, `src/api/*.php` или Twig-шаблоны могут продолжать подключать удалённые файлы.
- **Проверка:** выполните поиск по проекту (`rg "legacy" -g"*.php"`) и убедитесь, что пути обновлены. Запустите `composer dump-autoload` и убедитесь, что автозагрузка не ссылается на отсутствующие пространства имён.
- **Защита:** перед коммитом запустите smoke-тест: `php -l src/index.php` и `php -l` для ключевых entrypoint'ов, чтобы раннее поймать `require`-ошибки.

## 2. База данных и миграции
- **Риск:** старые миграции и сиды создают таблицы для удалённых модулей. После очистки миграций `phinx migrate` или `seed:run` может упасть.
- **Проверка:** сформируйте новый набор миграций, оставив только склад/заказы/ремонт. Запустите `php vendor/bin/phinx status` и убедитесь, что цепочка непрерывна.
- **Защита:** используйте переменную окружения `SEED_ON_START=false`, если сиды ещё не адаптированы. В `migrate.sh` предусмотрен обход сидов (см. ниже).

## 3. Twig-шаблоны и фронтенд
- **Риск:** макросы и навигация (`src/common/navbar.twig`, `src/dashboard*.twig`) могут ссылаться на удалённые страницы, что приведёт к 404 или JS-ошибкам.
- **Проверка:** прогоните `twigcs src` либо статический линтер; вручную пройдитесь по основным Twig-файлам и убедитесь, что все ссылки ведут на доступные контроллеры.
- **Защита:** внедрите smoke-тест UI (например, Playwright) после каждого крупного переноса.

## 4. Сервисные слои и фоновые задания
- **Риск:** сервисы уведомлений, cron-скрипты, интеграции (Slack, Drive и т.д.) могут ожидать данные из удалённых таблиц.
- **Проверка:** просмотр `src/server/cron`, `src/common/services` и CI-скриптов на зависимости от удалённых сущностей.
- **Защита:** либо удалите задачи, либо установите feature-флаги. Минимум — убедитесь, что cron не падает из-за `include` или SQL-ошибок.

## 5. Composer-пакеты
- **Риск:** при удалении модулей часть пакетов может стать неиспользуемой, но оставаться в `composer.json`. Это увеличит время развёртывания и риск конфликтов версий.
- **Проверка:** выполните `composer show --tree` и оцените, какие зависимости нужны оставшимся модулям.
- **Защита:** после чистки запустите `composer update --lock` для пересборки lock-файла и минимизации образа.

## 6. Тестовые данные и сиды
- **Риск:** сиды могут ссылаться на поля, которых больше нет в урезанной схеме.
- **Проверка:** временно запускайте сиды в пустой БД (`phinx seed:run -e production`).
- **Защита:** заведите отдельные сиды для MVP (`db/seeds_mvp`). В Docker их можно включать через `SEED_ON_START=true`.

## 7. Конфигурация окружения
- **Риск:** `.env` может содержать переменные для вырезанных сервисов, из‑за чего новички тратят время на настройку.
- **Проверка:** синхронизируйте `.env.example` с текущими требованиями (см. корневой файл) и проверьте, что `migrate.sh` валидирует только нужные переменные.
- **Защита:** используйте чек-лист ниже при развёртывании.

## Чек-лист перед выкатыванием MVP
1. **Composer:** `composer install` и `composer dump-autoload` проходят без ошибок.
2. **Миграции:** `php vendor/bin/phinx migrate -e production` и (опционально) `seed:run` выполняются либо пропускаются через `SEED_ON_START=false`.
3. **Логи PHP:** `php -d display_errors=1 -S localhost:8000 -t src` запускается без фатальных ошибок при переходе по складу/заказам/ремонту.
4. **Docker:** образ собирается командой `docker build -t lamerms .`, контейнер стартует через инструкции ниже.
5. **Документация:** `Readme.md` и `/legacy/README.md` отражают актуальные пути и порядок возврата старых модулей.

## Как предотвратить "приложение не запускается"
- Используйте новый `migrate.sh`: он проверяет обязательные переменные окружения и умеет пропускать сиды.
- Включите `set -euo pipefail` в bash-скриптах, чтобы контейнер останавливался при первой ошибке.
- Добавьте в CI smoke-тест `curl -f http://localhost/health` после сборки контейнера.
- Для локальной разработки держите `SEED_ON_START=false` и выполняйте сиды вручную после обновления данных.

Следуя этим шагам, перенос функциональности в `/legacy` и запуск MVP в Docker пройдут контролируемо и без простоев.
